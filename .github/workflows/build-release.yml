name: Build and Release

on:
  push:
    branches:
      - dev
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - dev
      - main

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Read version
      id: version
      run: |
        $version = (Get-Content VERSION).Trim()
        echo "VERSION=$version" >> $env:GITHUB_ENV
        echo "Version: $version"
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Windows executable (portable)
      run: |
        # Erstelle spec mit Version im Namen
        $specContent = Get-Content geothermie.spec -Raw
        $specContent = $specContent -replace "name='GeothermieErdsondentool'", "name='GeothermieErdsondentool-v$env:VERSION'"
        $specContent | Set-Content geothermie-versioned.spec
        pyinstaller geothermie-versioned.spec
    
    - name: Build Windows onedir (für Installer)
      run: |
        pyinstaller geothermie_onedir.spec
    
    - name: Download and install InstallForge
      run: |
        # InstallForge von GitHub Releases herunterladen und silent installieren
        Invoke-WebRequest -Uri "https://github.com/soner-boztas/installforge/releases/download/v1.6.1/IFInst.exe" -OutFile "if_setup.exe"
        Start-Process -FilePath ".\if_setup.exe" -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART" -Wait
    
    - name: Build Setup Installer with InstallForge
      run: |
        # Version in .ifp-Datei ersetzen
        $ifpContent = Get-Content "installer\GET_Setup.ifp" -Raw
        $ifpContent = $ifpContent -replace "3\.4\.0-beta1(\.5)?", "$env:VERSION"
        $ifpContent = $ifpContent -replace "Setup_GET_v3\.4\.0-beta1(\.5)?\.exe", "Setup_GET_v$env:VERSION.exe"
        $ifpContent | Set-Content "installer\GET_Setup.ifp"
        
        # InstallForge CLI Builder ausführen
        $ifBuild = "C:\Program Files (x86)\solicus\InstallForge\bin\ifbuildx86.exe"
        if (Test-Path $ifBuild) {
          & $ifBuild "installer\GET_Setup.ifp"
        } else {
          Write-Warning "InstallForge nicht gefunden – Installer-Build übersprungen"
          exit 1
        }
    
    - name: Upload Windows portable artifact
      uses: actions/upload-artifact@v4
      with:
        name: GeothermieErdsondentool-Windows
        path: dist/GeothermieErdsondentool-v*.exe
    
    - name: Upload Windows installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: GeothermieErdsondentool-Setup
        path: Setup_GET_v*.exe
        if-no-files-found: warn
  
  build-linux:
    name: Build Linux DEB
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Read version
      id: version
      run: |
        VERSION=$(cat VERSION | tr -d '[:space:]')
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Version: $VERSION"
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Linux executable
      run: |
        # Linux spec erstellen (ohne .ico Icon und mit korrektem Namen)
        sed "s/icon=.*$/icon=None,/" geothermie.spec | \
        sed "s/name='GeothermieErdsondentool'/name='geothermie-erdsondentool'/" > geothermie-linux.spec
        pyinstaller geothermie-linux.spec
    
    - name: Install fpm for DEB creation
      run: |
        sudo apt-get update
        sudo apt-get install -y ruby ruby-dev build-essential imagemagick
        sudo gem install fpm
    
    - name: Create DEB package
      run: |
        mkdir -p package/usr/local/bin
        mkdir -p package/usr/share/applications
        mkdir -p package/usr/share/pixmaps
        mkdir -p package/usr/share/doc/geothermie-erdsondentool
        
        cp dist/geothermie-erdsondentool package/usr/local/bin/
        chmod +x package/usr/local/bin/geothermie-erdsondentool
        
        # Icon konvertieren und kopieren
        convert Icons/icon.ico -resize 256x256 package/usr/share/pixmaps/geothermie-erdsondentool.png
        
        # Desktop Entry
        cat > package/usr/share/applications/geothermie-erdsondentool.desktop << EOF
        [Desktop Entry]
        Name=GET - Geothermie Erdsondentool
        Comment=Berechnung von Erdwärmesonden bis 100m
        Exec=/usr/local/bin/geothermie-erdsondentool
        Icon=geothermie-erdsondentool
        Terminal=false
        Type=Application
        Categories=Science;Engineering;Education;
        Keywords=geothermal;erdwaerme;geothermie;borehole;
        EOF
        
        # Documentation
        cp README.md package/usr/share/doc/geothermie-erdsondentool/
        cp LICENSE package/usr/share/doc/geothermie-erdsondentool/
        cp -r docs/* package/usr/share/doc/geothermie-erdsondentool/
        
        # Create DEB mit Version aus VERSION-Datei und Upgrade-Unterstützung
        fpm -s dir -t deb \
          -n geothermie-erdsondentool \
          -v $VERSION \
          --architecture amd64 \
          --description "Open-Source Tool zur Berechnung von Erdwärmesonden bis 100m Tiefe" \
          --url "https://github.com/3ddruck12/Geothermie-Erdsonden-Tool" \
          --maintainer "3ddruck12" \
          --license "MIT" \
          --deb-priority optional \
          --deb-no-default-config-files \
          -C package \
          usr/local/bin usr/share/applications usr/share/pixmaps usr/share/doc
    
    - name: Upload DEB artifact
      uses: actions/upload-artifact@v4
      with:
        name: GeothermieErdsondentool-Linux-DEB
        path: "*.deb"
  
  create-release:
    name: Create Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Read version
      id: version
      run: |
        VERSION=$(cat VERSION | tr -d '[:space:]')
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "Version: $VERSION"
    
    - name: Download Windows portable artifact
      uses: actions/download-artifact@v4
      with:
        name: GeothermieErdsondentool-Windows
    
    - name: Download Windows installer artifact
      uses: actions/download-artifact@v4
      with:
        name: GeothermieErdsondentool-Setup
      continue-on-error: true
    
    - name: Download Linux DEB artifact
      uses: actions/download-artifact@v4
      with:
        name: GeothermieErdsondentool-Linux-DEB
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          GeothermieErdsondentool-v*.exe
          Setup_GET_v*.exe
          *.deb
        tag_name: ${{ github.ref_name }}
        name: Release ${{ env.VERSION }}
        body: |
          ## Geothermie Erdsondentool Release ${{ env.VERSION }}
          
          ### Downloads
          - **Windows Installer**: `Setup_GET_v${{ env.VERSION }}.exe` (empfohlen)
          - **Windows Portable**: `GeothermieErdsondentool-v${{ env.VERSION }}.exe`
          - **Linux**: `geothermie-erdsondentool_${{ env.VERSION }}_amd64.deb`
          
          ### Installation
          
          #### Windows (Installer)
          1. `Setup_GET_v${{ env.VERSION }}.exe` herunterladen
          2. Setup-Wizard folgen
          3. Programm über Desktop- oder Startmenü-Verknüpfung starten
          
          #### Windows (Portable)
          1. `GeothermieErdsondentool-v${{ env.VERSION }}.exe` herunterladen
          2. Direkt ausführen (keine Installation nötig)
          
          #### Linux (Debian/Ubuntu)
          ```bash
          # Upgrade (keine Deinstallation nötig)
          sudo dpkg -i geothermie-erdsondentool_${{ env.VERSION }}_amd64.deb
          sudo apt-get install -f  # Falls Abhängigkeiten fehlen
          ```
          
          ### Features
          - ✅ Architektur-Refactoring (God-Class aufgelöst)
          - ✅ 71 pytest Unit-Tests
          - ✅ 5 Tab-Module + 2 Controller
          - ✅ Berechnung von Erdwärmesonden bis 100m
          - ✅ PE 100 RC Rohre mit Dual- und 4-Verbinder
          - ✅ PDF-Berichtserstellung
          - ✅ PVGIS Klimadaten-Integration
          - ✅ Bodendatenbank nach VDI 4640
          - ✅ VDI 4640 Berechnungsmethode
          - ✅ Bohrfeld-Simulation mit g-Funktionen
          - ✅ Wasserrechtliche Bohranzeige (§ 49 WHG)
          - ✅ OSM-Karte & Lageplan
          
          [Vollständige Dokumentation](https://github.com/3ddruck12/Geothermie-Erdsonden-Tool/tree/main/docs)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

